<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>IoT Anti-Gaspi Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: white; margin: 0; padding: 20px; }

        .iot-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: 90vh; }

        .panel { background: var(--card); border-radius: 10px; padding: 15px; border: 1px solid #334155; display: flex; flex-direction: column; }

        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 8px; font-size: 1rem; margin: 0 0 10px 0; }

        button { padding: 7px 12px; margin-bottom: 8px; background: var(--accent); border: none; border-radius: 5px; cursor: pointer; color: black; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }
        button:hover { background: #22d3ee; }

        input[type="file"] { display: none; }

        video { border-radius: 8px; margin-bottom: 8px; max-width: 100%; }

        .status-valide { color: #4ade80; }
        .status-alerte { color: #fbbf24; }
        .status-perime { color: #f87171; }

        .console { background: black; padding: 12px; border-radius: 5px; font-size: 0.8rem; flex-grow: 1; overflow-y: auto; color: #4ade80; }

        .ai-card { background: #0ea5e91a; border: 1px solid var(--accent); padding: 12px; border-radius: 8px; line-height: 1.5; white-space: pre-wrap; min-height: 100px; }

        .loader { display: none; color: var(--accent); font-weight: bold; margin-top: 5px; font-size: 0.9rem; }

        #clock {
            background: #000;
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid var(--accent);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<header style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <h1 style="margin: 0; font-size:1.2rem;">Ne gaspillez plus !!!</h1>
    <div id="clock"></div>
</header>

<div class="iot-grid">
    <!-- Panel Upload / Cam√©ra compact -->
    <div class="panel">
        <h2>üì∏ Ajouter un produit</h2>
        <button id="upload-btn">Importer une image</button>
        <input type="file" id="file-input" accept="image/*">
        <button id="camera-btn">üì∑ Prendre une photo</button>
        <video id="camera-stream" autoplay playsinline style="display:none;"></video>
        <button id="capture-btn" style="display:none;">Capturer</button>
        <div id="loader" class="loader">ANALYSE EN COURS...</div>
    </div>

    <!-- Panel Console + IA -->
    <div class="panel">
        <h2>‚öôÔ∏è R√©sultats & Assistant IA</h2>
        <div id="console-output" class="console">> Pr√™t pour scan...</div>
        <h2 style="margin-top: 10px;">ü§ñ Recommandation</h2>
        <div id="ai-output" class="ai-card">En attente d'analyse produit...</div>
    </div>
</div>

<script>
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');
    const cameraBtn = document.getElementById('camera-btn');
    const video = document.getElementById('camera-stream');
    const captureBtn = document.getElementById('capture-btn');
    const loader = document.getElementById('loader');
    const consoleBox = document.getElementById('console-output');
    const aiOutput = document.getElementById('ai-output');

    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if(file) runAnalysis(file);
    };

    cameraBtn.onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = 'block';
        captureBtn.style.display = 'block';
    };

    captureBtn.onclick = () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        captureBtn.style.display = 'none';

        canvas.toBlob(blob => {
            runAnalysis(blob);
        }, 'image/jpeg');
    };

    function runAnalysis(fileOrBlob) {
        loader.style.display = 'block';
        const formData = new FormData();
        formData.append('image', fileOrBlob);

        fetch('/process-upload', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                consoleBox.innerHTML += `<br><span style="color:white">> Analyse du produit...</span>`;
                consoleBox.innerHTML += `<br>  [RAW TEXT]: ${data.raw_text}`;
                consoleBox.innerHTML += `<br>  [REGEX]: Date trouv√©e -> ${data.dlc}`;
                consoleBox.innerHTML += `<br>  [IOT STATE]: <span class="${data.status_class}">${data.status}</span>`;

                aiOutput.innerHTML = data.recommendation;
                loader.style.display = 'none';
                consoleBox.scrollTop = consoleBox.scrollHeight;
            })
            .catch(err => {
                consoleBox.innerHTML += `<br><span style="color:red">Erreur: ${err}</span>`;
                loader.style.display = 'none';
            });
    }

    function updateClock() {
        const clockElement = document.getElementById('clock');
        const now = new Date();
        const day = String(now.getDate()).padStart(2,'0');
        const month = String(now.getMonth()+1).padStart(2,'0');
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2,'0');
        const minutes = String(now.getMinutes()).padStart(2,'0');
        const seconds = String(now.getSeconds()).padStart(2,'0');
        clockElement.textContent = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
    }

    setInterval(updateClock, 1000);
    updateClock();
</script>

</body>
</html>
